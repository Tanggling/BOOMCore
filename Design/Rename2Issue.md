*ps:此篇文档对BOOM设计的重命名到发射阶段流程进行说明*



## 说明

在BOOM的设计中，后端从重命名开始，接收前端**DECODER**传来的打包信号。

按照正常流水情况，我们为双发射结构，每次要对两条指令同时操作，要注意两条同时发射指令之间的数据依赖和数据冒险关系。

本篇文档为对**RENAME**、**DISPATCH**、**ISSUE**级模块和规则说明，其中，涉及相关的模块还包括：ARF（体系结构寄存器堆）、RAT（寄存器映射表，有两张，分别为R级和C级，参照WIRED的实现）、ROB（重排序缓存）、ROB_PRF（物理寄存器堆）、IQ（发射队列）、CDB_BUS（CDB转发总线）、WKUP_BUS（背靠背唤醒）。



## RENAME级（R级）

### 1. 单条指令

对于某一条指令独立来看，其在重命名级涉及对**目的寄存器**的映射关系的写、**源寄存器**的映射关系的读，以及读取ARF的操作。

我们假设该指令为标准状况：

```asm
op  r1,  r2,  r3
```

r1为目的寄存器， r2、r3则为源寄存器。

* 目的寄存器的映射关系：判断ROB是否有空余表项（ROB规格为64项，正常情况保证后端占满时ROB也会有空余位置），若有，则选择新的表项编号作为物理寄存器编号，填入R级RAT。如果提交级中将数据写回ARF，则要写入C级RAT，同时注意设置单独标志位，防止后来指令重命名时覆盖同一项且写入寄存器相同的情况（虽然这基本不可能发生）。
* 源寄存器的映射关系：判断R级RAT表和C级RAT表对应表项是否相等，若相等，代表可以从ARF中读到最新结果，反之，则要到ROB_PRF中读取数据，但是这个数据的读取不在R级。

### 2. 双指令

对于两条指令主要考虑了同时从前端传过来的两条指令之间的数据依赖关系（如果是传来两条指令的话）。

考虑以下情况：

```asm
op1  r1,  r2,  r3
op2  r4,  r1,  r5
```

注意到此处，op2的一个源寄存器r1与op1的目的寄存器一致，如果不做特殊处理，那么op2的r1寄存器会从ARF或者其他PRF中读取，但是实际上应该是要从op1对应的PRF中读取的。因此对于op2源寄存器的选择，需要加上多路选择的逻辑，即除了ARF、RAT读取映射结果外，还有可能来自于op1的PRF。



## DISPATCH（P级）

单独一级，和ISSUE级共用ready信号和RENAME级握手；与ISSUE级由ready & valid信号握手。这里的逻辑是，如果有一个IQ满了且后端被阻塞了，则不再允许 R->P级的流水，也不允许P->I级的流水。

本级要完成的操作有：将指令信息写入ROB中，从ROB中读出所需源操作数（ROB中实现读写内部转发，若为准备好，则送入IQ监听CDB），生成不同类型指令valid信号（送入后续IQ中判断的依据）。

源操作数对应的物理寄存器编号来源于之前的重命名级的结果，在P级，会去找ROB中对应编号的数据是否已经写入，或者和CDB写入的结果一致，那么可以捕获数据，源操作数准备好，后续不用再等待这一源操作数。

同时，要将此条指令的相关信息（静态信息写入ROB中，同时注意要避免阻塞时的重复写入）。

此处对应的端口为**双写口四读口**。



## ISSUE级（I级）

本质上是要管理一个FIFO，在FIFO中管理的是iq_entry，entry中有以下信息

| PC   | WID  | RID1 | RDATA1 | RVALID1 | RID2 | RDATA2 | RVALID2 | WKUP SRC | INST VALID | EXC INFORM | OHTER INFORM |
| ---- | ---- | ---- | ------ | ------- | ---- | ------ | ------- | -------- | ---------- | ---------- | ------------ |
|      |      |      |        |         |      |        |         |          |            |            |              |

若之前已经在ARF中获取数据，则对应源寄存器valid置1，相应数据可用（如果不需要寄存器，例如数据为立即数型，则无条件置1）

否则，监听后面的数据，其所需数据来源此时可能在CDB总线上，也有可能是在下个周期某条指令的执行结果。

那么，唤醒条件有两个，一个是cdb_hit（持续监听CDB信息），另一个是wkup_hit（背靠背唤醒，只会来自于LSU的结果和ALU的结果）。

* CDB唤醒逻辑：CDB_HIT信号产生（此时CDB总线的数据即为所需数据，存入source data，后续发射之后使用该表项里的数据）；
* 背靠背唤醒逻辑：WKUP_HIT信号产生（发射指令提供WKUP信息，IQ中的每一项比对信息，判断命中），若命中，则处于被唤醒状态，若下一周期被唤醒指令被发射，那么用旁路转发数据，否则，在下一周期将数据写入iq_entry中。



## ISSUE2CDB

这并不是流水级，而是数据通过ISSUE之后的FU产生结果到CDB总线仲裁然后数据前递和数据转发的过程。

### 1. 数据写回流程

* FU->CDB_ARB：数据通过FU，产生结果之后，需要经过一个fifo，若fifo里面无数据，且后端无阻塞，则可以数据直达cdb仲裁，否则，要存入fifo然后按照先进先出策略取数据；
* CDB_ARB->ROB：多路FU的数据不一定能够进入CDB_ARB的后端，一次只选择两路CDB信号进行写回，选择之后，下一拍写入ROB，提交级完成写入ARF和写回SB。

### 2. 数据转发流程

详见图